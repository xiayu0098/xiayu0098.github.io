<script src="/assets/js/APlayer.min.js"> </script><!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AFEA Serial Number Generator</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121930;
      --ink: #eaf0ff;
      --muted: #97a3c0;
      --accent: #6aa9ff;
      --accent-2: #8ef0c2;
      --warn: #ffca6a;
      --ok: #5ee595;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: var(--sans); color: var(--ink); background: radial-gradient(1200px 800px at 20% -10%, #12214a, #0b1020 60%); }
    .container { max-width: 980px; margin: 32px auto; padding: 0 16px; }
    header h1 { font-weight: 800; letter-spacing: 0.5px; margin: 0 0 4px; }
    header p { color: var(--muted); margin: 8px 0 24px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); backdrop-filter: blur(6px); }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(12, 1fr); }
    .col-12 { grid-column: span 12; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .col-3 { grid-column: span 3; }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, select, button { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.14); background: #0f1530; color: var(--ink); }
    input:focus, select:focus, button:focus { outline: 2px solid var(--accent); outline-offset: 2px; }
    .row { display: flex; flex-wrap: wrap; gap: 8px; }
    .btn { cursor: pointer; font-weight: 600; }
    .btn-primary { background: linear-gradient(180deg, #2c57ff, #1740d9); border-color: #3053ff; }
    .btn-secondary { background: linear-gradient(180deg, #243058, #1c2542); }
    .btn-ghost { background: transparent; border-color: rgba(255,255,255,0.18); }
    .inline { display: inline-flex; gap: 8px; align-items: center; }
    .muted { color: var(--muted); }
    .mono { font-family: var(--mono); font-size: 0.95rem; }
    .pill { padding: 2px 8px; border-radius: 999px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); font-size: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,0.08); vertical-align: top; }
    th { font-size: 12px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
    .right { text-align: right; }
    .toast { position: fixed; right: 16px; bottom: 16px; background: #111a33; border: 1px solid rgba(255,255,255,0.12); color: var(--ink); padding: 12px 14px; border-radius: 10px; box-shadow: 0 10px 28px rgba(0,0,0,0.35); display: none; }
    .hint { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    details summary { cursor: pointer; }
    @media (max-width: 820px) { .col-6, .col-4, .col-3 { grid-column: span 12; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>AFEA Serial Number Generator</h1>
      <p class="muted">Format: <span class="mono pill">AFEA-YYWww-####-C</span> — ISO week, zero‑padded global counter, and a check letter (digits-sum mod 24; alphabet without I/O).</p>
    </header>

    <section class="card" aria-labelledby="gen-title">
      <h2 id="gen-title" style="margin:6px 0 12px">Generate</h2>
      <div class="grid">
        <div class="col-3">
          <label for="prefix">Company</label>
          <input id="prefix" value="AFEA" autocomplete="off">
          <div class="hint">Keep as <strong>AFEA</strong> for policy consistency.</div>
        </div>
        <div class="col-3">
          <label for="date">Date (for ISO week)</label>
          <input id="date" type="date">
          <div class="hint">Uses ISO <em>week year</em> around New Year.</div>
        </div>
        <div class="col-3">
          <label for="seqWidth">Sequence width</label>
          <select id="seqWidth">
            <option value="4" selected>4 digits (0001…)</option>
            <option value="5">5 digits (00001…)</option>
            <option value="6">6 digits (000001…)</option>
          </select>
          <div class="hint">Change when growth needs it.</div>
        </div>
        <div class="col-3">
          <label for="count">How many to generate</label>
          <input id="count" type="number" min="1" step="1" value="10">
        </div>

        <div class="col-6">
          <label for="counter">Global counter (next number)</label>
          <input id="counter" type="number" min="1" step="1">
          <div class="hint">Persists in this browser (localStorage). Never resets.</div>
        </div>
        <div class="col-6">
          <label>&nbsp;</label>
          <div class="row">
            <button class="btn btn-primary" id="btnGen" type="button">Generate SNs</button>
            <button class="btn btn-secondary" id="btnCopyAll" type="button">Copy all SNs</button>
            <button class="btn btn-ghost" id="btnCsv" type="button">Download CSV</button>
            <button class="btn btn-ghost" id="btnReset" type="button" title="Does not affect past SNs">Reset counter…</button>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-top:8px">
        <div class="col-3">
          <label class="inline"><input id="qrEnabled" type="checkbox" checked style="width:auto;margin-right:8px"> Show QR for each SN</label>
          <div class="hint">Scannable code in the table below.</div>
        </div>
        <div class="col-3">
          <label for="qrSize">QR size (px)</label>
          <select id="qrSize">
            <option value="128" selected>128</option>
            <option value="192">192</option>
            <option value="256">256</option>
          </select>
          <div class="hint">Rendered via an online QR service.</div>
        </div>
        <div class="col-6">
          <label for="qrPrefix">QR content prefix (optional)</label>
          <input id="qrPrefix" placeholder="e.g., https://afea.example/sn/">
          <div class="hint">Encoded content = <span class="mono">prefix + SN</span>. Leave empty to encode just the SN.</div>
        </div>
      </div>

      <div class="hint" style="margin-top:12px">Current ISO week based on selected date: <span id="isoInfo" class="mono"></span></div>

      <div id="results" style="margin-top:14px">
        <table aria-label="Generated serial numbers">
          <thead>
            <tr>
              <th>#</th>
              <th>Serial Number</th>
              <th>Base</th>
              <th class="right">Digits sum</th>
              <th>Check</th>
              <th>QR</th>
              <th class="right">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <section class="card" style="margin-top:16px" aria-labelledby="val-title">
      <h2 id="val-title" style="margin:6px 0 12px">Validate an SN</h2>
      <div class="grid">
        <div class="col-6">
          <label for="snInput">Enter SN</label>
          <input id="snInput" placeholder="AFEA-25W41-0123-U">
        </div>
        <div class="col-6">
          <label>&nbsp;</label>
          <div class="row">
            <button class="btn btn-secondary" id="btnCheck" type="button">Check</button>
            <span id="valResult" class="inline pill" aria-live="polite"></span>
          </div>
        </div>
      </div>
      <p class="hint">Rule: remove non‑digits, sum digits, map <span class="mono">sum mod 24</span> into alphabet <span class="mono">ABCDEFGHJKLMNPQRSTUVWXYZ</span>.</p>
    </section>

    <section class="card" style="margin-top:16px" aria-labelledby="test-title">
      <h2 id="test-title" style="margin:6px 0 12px">Self‑tests</h2>
      <details open>
        <summary>View results</summary>
        <div id="testResults" class="mono" style="margin-top:8px"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn btn-ghost" id="btnRunTests" type="button">Run tests again</button>
        </div>
        <p class="hint">These quick checks verify ISO week/year handling, checksum mapping, and the validator.</p>
      </details>
    </section>

    <footer class="muted" style="margin:16px 4px 0; font-size:12px">
      <span class="pill">Policy</span> No product info in SN. One global counter. Assign at build start. Keep the same SN through repairs.
    </footer>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // === Constants ===
    const ALPHABET = "ABCDEFGHJKLMNPQRSTUVWXYZ"; // 24 letters (no I, O)
    const STORAGE_KEY = "afea.sn.counter";
    const STORAGE_WIDTH = "afea.sn.seqwidth";

    // === Helpers ===
    function pad(n, w) { return String(n).padStart(w, '0'); }
    function onlyDigits(s) { return s.replace(/\D+/g, ''); }
    function digitSum(s) { return onlyDigits(s).split('').reduce((a, c) => a + Number(c), 0); }
    function checkLetterFromSum(sum) { return ALPHABET[sum % ALPHABET.length]; }

    // ISO week + ISO week year (local-time implementation)
    function isoYearWeek(date) {
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const day = (d.getDay() + 6) % 7; // 0=Mon..6=Sun (Mon-based)
      d.setDate(d.getDate() + 3 - day); // shift to Thu of this ISO week
      const isoYear = d.getFullYear();
      const firstThursday = new Date(isoYear, 0, 4);
      const firstDay = (firstThursday.getDay() + 6) % 7; // 0=Mon..6=Sun
      firstThursday.setDate(firstThursday.getDate() + 3 - firstDay);
      const week = 1 + Math.round((d - firstThursday) / 604800000); // 7*24*3600*1000
      return { isoYear, isoWeek: week };
    }

    function makeBase(prefix, date, seq, width) {
      const { isoYear, isoWeek } = isoYearWeek(date);
      const yy = String(isoYear % 100).padStart(2, '0');
      const wk = pad(isoWeek, 2);
      const seqStr = pad(seq, width);
      return `${prefix}-${yy}W${wk}-${seqStr}`;
    }

    function makeSN(prefix, date, seq, width) {
      const base = makeBase(prefix, date, seq, width);
      const sum = digitSum(base);
      const check = checkLetterFromSum(sum);
      return { sn: `${base}-${check}`, base, sum, check };
    }

    function showToast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg; el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 1800);
    }

    function todayISO() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function getStoredCounter() {
      const v = Number(localStorage.getItem(STORAGE_KEY));
      return Number.isFinite(v) && v > 0 ? v : 1;
    }
    function setStoredCounter(v) { localStorage.setItem(STORAGE_KEY, String(v)); }
    function getStoredWidth() {
      const v = Number(localStorage.getItem(STORAGE_WIDTH));
      return (v === 4 || v === 5 || v === 6) ? v : 4;
    }
    function setStoredWidth(v) { localStorage.setItem(STORAGE_WIDTH, String(v)); }

    function updateIsoInfo(date) {
      const { isoYear, isoWeek } = isoYearWeek(date);
      const yy = String(isoYear % 100).padStart(2,'0');
      document.getElementById('isoInfo').textContent = `ISO ${isoYear} (YY=${yy}), week ${String(isoWeek).padStart(2,'0')}`;
    }

    function renderRows(list) {
      const tbody = document.getElementById('rows');
      tbody.innerHTML = '';
      const qrEnabled = document.getElementById('qrEnabled') ? document.getElementById('qrEnabled').checked : false;
      const qrSize = document.getElementById('qrSize') ? Math.max(64, parseInt(document.getElementById('qrSize').value, 10) || 128) : 128;
      const qrThumb = 64; // displayed size in table
      const qrPrefix = document.getElementById('qrPrefix') ? document.getElementById('qrPrefix').value.trim() : '';

      for (const item of list) {
        const tr = document.createElement('tr');
        const encoded = encodeURIComponent(qrPrefix ? (qrPrefix + item.sn) : item.sn);
        const qrSrc = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encoded}`;
        const qrHtml = qrEnabled ? `<img src="${qrSrc}" alt="QR for ${item.sn}" width="${qrThumb}" height="${qrThumb}" style="border:1px solid rgba(255,255,255,0.12); border-radius:6px;" />` : '<span class="muted">—</span>';
        tr.innerHTML = `
          <td class="mono">${item.idx}</td>
          <td class="mono"><strong>${item.sn}</strong></td>
          <td class="mono">${item.base}</td>
          <td class="mono right">${item.sum}</td>
          <td class="mono">${item.check}</td>
          <td>${qrHtml}</td>
          <td class="right">
            <button class="btn btn-ghost" data-copy="${item.sn}">Copy</button>
          </td>`;
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll('button[data-copy]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const value = e.currentTarget.getAttribute('data-copy');
          try { await navigator.clipboard.writeText(value); showToast('Copied'); } catch { showToast('Copy failed'); }
        });
      });
    }

    function downloadCSV(rows) {
      const header = ['index','sn','base','digits_sum','check'];
      const lines = [header.join(',')];
      rows.forEach(r => lines.push([r.idx, r.sn, r.base, r.sum, r.check].join(',')));
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'AFEA_SNs.csv';
      document.body.appendChild(a); a.click();
      setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
    }

    // === Self-tests ===
    function runTests() {
      const results = [];
      function assert(name, cond) { results.push({ name, pass: !!cond }); }

      // 1) Alphabet rules
      assert('Alphabet length is 24', ALPHABET.length === 24);
      assert('Alphabet excludes I and O', !ALPHABET.includes('I') && !ALPHABET.includes('O'));

      // 2) Checksum for known base
      const base = 'AFEA-25W41-0123';
      assert('digitSum("AFEA-25W41-0123") == 18', digitSum(base) === 18);
      assert('checkLetterFromSum(18) == "U"', checkLetterFromSum(18) === 'U');

      // 3) ISO week edge cases around New Year
      const d1 = new Date('2021-01-01'); // Fri, ISO: 2020-W53
      const iw1 = isoYearWeek(d1);
      assert('2021-01-01 has ISO year 2020', iw1.isoYear === 2020);
      assert('2021-01-01 is ISO week 53', iw1.isoWeek === 53);

      const d2 = new Date('2021-01-04'); // Mon, first week of 2021
      const iw2 = isoYearWeek(d2);
      assert('2021-01-04 has ISO year 2021', iw2.isoYear === 2021);
      assert('2021-01-04 is ISO week 01', iw2.isoWeek === 1);

      // 4) makeBase formatting using our ISO week
      const d3 = new Date('2025-10-09');
      const iw3 = isoYearWeek(d3);
      const expectedBase = `AFEA-${String(iw3.isoYear % 100).padStart(2,'0')}W${String(iw3.isoWeek).padStart(2,'0')}-0123`;
      assert('makeBase matches expected', makeBase('AFEA', d3, 123, 4) === expectedBase);

      // 5) Regex acceptance for a valid SN with U
      const validSn = 'AFEA-25W41-0123-U';
      const re = /^\s*AFEA-[0-9]{2}W[0-9]{2}-[0-9]{4,6}-[A-Z]\s*$/;
      assert('Regex matches valid SN', re.test(validSn));
      // Check-letter correctness
      const parts = validSn.split('-');
      const expected = checkLetterFromSum(digitSum(parts.slice(0,3).join('-')));
      assert('Validator check letter matches', expected === parts[3]);

      // Present results
      const el = document.getElementById('testResults');
      el.innerHTML = '<table><thead><tr><th>Test</th><th>Status</th></tr></thead><tbody>' +
        results.map(r => `<tr><td>${r.name}</td><td>${r.pass ? '✅ PASS' : '❌ FAIL'}</td></tr>`).join('') + '</tbody></table>';
      return results.every(r => r.pass);
    }

    // === Init & Events ===
    document.addEventListener('DOMContentLoaded', () => {
      const prefixEl = document.getElementById('prefix');
      const dateEl = document.getElementById('date');
      const widthEl = document.getElementById('seqWidth');
      const countEl = document.getElementById('count');
      const counterEl = document.getElementById('counter');

      // Defaults
      dateEl.value = todayISO();
      counterEl.value = getStoredCounter();
      widthEl.value = String(getStoredWidth());
      updateIsoInfo(new Date(dateEl.value));

      dateEl.addEventListener('change', () => updateIsoInfo(new Date(dateEl.value)));
      widthEl.addEventListener('change', (e) => setStoredWidth(Number(e.target.value)));

      document.getElementById('btnGen').addEventListener('click', () => {
        const date = new Date(dateEl.value);
        const prefix = (prefixEl.value || 'AFEA').toUpperCase().replace(/[^A-Z0-9-]/g, '');
        let next = Math.max(1, parseInt(counterEl.value, 10) || 1);
        const count = Math.max(1, parseInt(countEl.value, 10) || 1);
        const width = Number(widthEl.value);

        const out = [];
        for (let i = 0; i < count; i++) {
          const { sn, base, sum, check } = makeSN(prefix, date, next + i, width);
          out.push({ idx: next + i, sn, base, sum, check });
        }
        renderRows(out);
        // advance and persist counter
        next = next + count;
        counterEl.value = next;
        setStoredCounter(next);
      });

      document.getElementById('btnCopyAll').addEventListener('click', async () => {
        const rows = Array.from(document.querySelectorAll('#rows tr'));
        if (!rows.length) { showToast('Nothing to copy'); return; }
        const list = rows.map(r => r.children[1].innerText.trim()).join('\n');
        try { await navigator.clipboard.writeText(list); showToast('All SNs copied'); } catch { showToast('Copy failed'); }
      });

      document.getElementById('btnCsv').addEventListener('click', () => {
        const rows = Array.from(document.querySelectorAll('#rows tr'));
        if (!rows.length) { showToast('Nothing to export'); return; }
        const data = rows.map((r) => ({
          idx: r.children[0].innerText.trim(),
          sn: r.children[1].innerText.trim(),
          base: r.children[2].innerText.trim(),
          sum: r.children[3].innerText.trim(),
          check: r.children[4].innerText.trim()
        }));
        downloadCSV(data);
      });

      document.getElementById('btnReset').addEventListener('click', () => {
        const v = prompt('Set new starting counter (>=1). This does not change previously generated SNs.');
        if (!v) return;
        const n = Math.max(1, parseInt(v, 10) || 1);
        setStoredCounter(n);
        document.getElementById('counter').value = n;
        showToast('Counter updated');
      });

      document.getElementById('btnCheck').addEventListener('click', () => {
        const raw = document.getElementById('snInput').value.trim();
        const res = document.getElementById('valResult');
        if (!/^\s*AFEA-[0-9]{2}W[0-9]{2}-[0-9]{4,6}-[A-Z]\s*$/.test(raw)) {
          res.textContent = 'Format looks unusual (expected AFEA-YYWww-####-C)'; res.className = 'inline pill warn'; return;
        }
        const parts = raw.split('-');
        const base = parts.slice(0, 3).join('-');
        const expected = checkLetterFromSum(digitSum(base));
        const got = parts[3].trim().toUpperCase();
        if (expected === got) { res.textContent = 'Valid ✓'; res.className = 'inline pill ok'; }
        else { res.textContent = `Mismatch — expected ${expected}`; res.className = 'inline pill warn'; }
      });

      // Run tests on load and wire the button
      runTests();
      document.getElementById('btnRunTests').addEventListener('click', runTests);
    });
  </script>
</body>
</html>

