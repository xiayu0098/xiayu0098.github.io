<script src="/assets/js/APlayer.min.js"> </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Scheduler (Dec 2025 Update)</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --container-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #4CAF50;
            --secondary-color: #2196F3;
            --border-color: #444;
            --input-bg: #383838;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 800px;
        }

        h1 { margin-top: 0; font-size: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.9rem; }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: white;
            box-sizing: border-box;
            font-family: monospace;
        }

        textarea { height: 150px; resize: vertical; }

        .row { display: flex; gap: 20px; }
        .col { flex: 1; }

        button {
            margin-top: 20px;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: opacity 0.2s;
        }

        .btn-generate { background-color: var(--secondary-color); color: white; width: 100%; }
        .btn-download { background-color: var(--accent-color); color: white; display: none; width: 100%; }
        
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button:hover:not(:disabled) { opacity: 0.9; }

        #preview {
            margin-top: 20px;
            background: #111;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            border: 1px solid var(--border-color);
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Settings Toggle Styling */
        details { margin-top: 20px; border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; background: #252525; }
        summary { cursor: pointer; font-weight: bold; color: #aaa; outline: none; }
        summary:hover { color: #fff; }

        .loading { text-align: center; display: none; margin-top: 10px; font-style: italic; color: #888; }
    </style>
</head>
<body>

<div class="container">
    <h1>Smart .ICS Scheduler</h1>

    <div class="row">
        <div class="col">
            <label for="apiKey">Gemini API Key</label>
            <input type="password" id="apiKey" placeholder="Paste Key (starts with AIza...)">
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label for="scheduleDate">Date to Schedule</label>
            <input type="date" id="scheduleDate">
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label for="timeZone">Time Zone</label>
            <select id="timeZone">
                <option value="Australia/Melbourne" selected>Australia/Melbourne</option>
                <option value="Australia/Sydney">Australia/Sydney</option>
                <option value="Asia/Shanghai">China (Shanghai)</option>
                <option value="Asia/Tokyo">Japan (Tokyo)</option>
                <option value="Europe/London">UK (London)</option>
                <option value="America/New_York">US (New York)</option>
                <option value="UTC">UTC</option>
            </select>
        </div>
        <div class="col">
            <label for="modelName">AI Model (Dec 2025)</label>
            <select id="modelName">
                <option value="gemini-2.5-flash" selected>Gemini 2.5 Flash (Standard)</option>
                <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite (Low Cost/Free)</option>
                <option value="gemini-2.5-pro">Gemini 2.5 Pro (High Power)</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label for="workStart">Work Start</label>
            <input type="time" id="workStart" value="09:00">
        </div>
        <div class="col">
            <label for="workEnd">Work End</label>
            <input type="time" id="workEnd" value="21:00">
        </div>
    </div>

    <label for="tasks">To-Do List / Instructions</label>
    <textarea id="tasks" placeholder="Example:
- Meeting with someone at 10am for 1 hour
- Need 2 hours for writing
- 30 mins report review
- Arrange a test for fixed board in the afternoon (3-4pm)
- Leave 1.5h for lunch"></textarea>

    <button id="generateBtn" class="btn-generate" onclick="generateSchedule()">âœ¨ Ask Gemini to Arrange Schedule</button>
    <div id="loading" class="loading">Thinking and arranging...</div>

    <div id="preview"></div>
    <button id="downloadBtn" class="btn-download" onclick="downloadICS()">Download .ics File</button>
</div>

<script>
    // Initialize default date to local today
    window.onload = function() {
        const localDate = new Date();
        const year = localDate.getFullYear();
        const month = String(localDate.getMonth() + 1).padStart(2, '0');
        const day = String(localDate.getDate()).padStart(2, '0');
        document.getElementById('scheduleDate').value = `${year}-${month}-${day}`;
    };

    let currentICSContent = "";

    async function generateSchedule() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const modelName = document.getElementById('modelName').value;
        const timeZone = document.getElementById('timeZone').value;
        const tasks = document.getElementById('tasks').value;
        const workStart = document.getElementById('workStart').value;
        const workEnd = document.getElementById('workEnd').value;
        const scheduleDate = document.getElementById('scheduleDate').value; 

        const loadingDiv = document.getElementById('loading');
        const previewDiv = document.getElementById('preview');
        const downloadBtn = document.getElementById('downloadBtn');

        if (!apiKey) { alert("Please enter your Gemini API Key."); return; }
        if (!tasks) { alert("Please enter some tasks."); return; }
        if (!scheduleDate) { alert("Please select a date."); return; }

        loadingDiv.style.display = 'block';
        previewDiv.style.display = 'none';
        downloadBtn.style.display = 'none';

        const prompt = `
            You are a smart scheduling assistant. 
            The user is located in the time zone: ${timeZone}.
            The user wants to generate a schedule for this specific date: ${scheduleDate} (YYYY-MM-DD).
            The working hours are between ${workStart} and ${workEnd}.
            
            Here are the user's tasks and constraints:
            "${tasks}"

            INSTRUCTIONS:
            1. Parse the tasks and arrange them logically within the work hours on ${scheduleDate}.
            2. Respect fixed times if mentioned (e.g., "at 10am").
            3. Fill in flexible tasks around fixed ones.
            4. Ensure there is a lunch break if requested or if the day is long.
            5. Return ONLY a valid JSON array of objects.
            
            JSON Structure:
            [
                {
                    "summary": "Task Title",
                    "start": "YYYYMMDDTHHmm00",
                    "end": "YYYYMMDDTHHmm00",
                    "description": "Details"
                }
            ]
            
            IMPORTANT: Dates must be in format YYYYMMDDTHHmm00 (e.g., 20251208T093000). Use 24-hour format.
        `;

        try {
            // Using v1beta endpoint which supports the newer model names
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();
            
            if (data.error) {
                console.error("API Error:", data.error);
                throw new Error(data.error.message || "Unknown API Error");
            }

            if (!data.candidates || !data.candidates[0].content) {
                throw new Error("No content returned. Check if the model name is correct.");
            }

            let rawText = data.candidates[0].content.parts[0].text;
            // Sanitizing Markdown
            rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
            
            const events = JSON.parse(rawText);
            createICS(events, timeZone);

        } catch (error) {
            alert("Error: " + error.message + "\n\nTip: If you get a 'Limit' or 'Not Found' error, try switching to 'Gemini 2.5 Flash Lite' in the dropdown.");
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    function createICS(events, timeZone) {
        // Headers with dynamic timezone
        let icsData = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Gemini//Smart Scheduler//EN\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n";
        icsData += "X-WR-CALNAME:Work Schedule\n";
        icsData += `X-WR-TIMEZONE:${timeZone}\n`;
        
        let previewText = "Proposed Schedule:\n------------------\n";

        events.forEach(event => {
            // Formatting for Preview
            const startStr = event.start.split('T')[1].substring(0,4);
            const endStr = event.end.split('T')[1].substring(0,4);
            const formattedStart = startStr.substring(0,2) + ":" + startStr.substring(2);
            const formattedEnd = endStr.substring(0,2) + ":" + endStr.substring(2);
            
            previewText += `${formattedStart} - ${formattedEnd} : ${event.summary}\n`;

            // Formatting for ICS with User Selected Timezone
            icsData += "BEGIN:VEVENT\n";
            icsData += `SUMMARY:${event.summary}\n`;
            icsData += `DTSTART;TZID=${timeZone}:${event.start}\n`;
            icsData += `DTEND;TZID=${timeZone}:${event.end}\n`;
            icsData += `DESCRIPTION:${event.description || ''}\n`;
            icsData += "STATUS:CONFIRMED\n";
            icsData += "END:VEVENT\n";
        });

        icsData += "END:VCALENDAR";
        currentICSContent = icsData;

        const previewDiv = document.getElementById('preview');
        previewDiv.innerText = previewText;
        previewDiv.style.display = 'block';
        document.getElementById('downloadBtn').style.display = 'block';
    }

    function downloadICS() {
        const blob = new Blob([currentICSContent], { type: 'text/calendar' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'schedule.ics';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }
</script>

</body>
</html>
